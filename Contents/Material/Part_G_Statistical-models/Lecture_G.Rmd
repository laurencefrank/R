---
title: "Lecture G - Statistical Models"
author: "Gerko Vink"
date: "Statistical Programming with R"
output:
  ioslides_presentation:
    logo: logo.png
    smaller: no
    widescreen: no
---

## I use the following packages in this lecture
```{r message=FALSE}
library(magrittr) #for pipes
library(MASS)     #for the cats and bacteria data
library(mice)     #for the boys data
```

### Function:

- `lm()` to run linear models


```{r echo=FALSE}
set.seed(123)
```

# Statistical models

## Statistical model

The mathematical formulation of relationship between variables can be written as

\[
\mbox{observed}=\mbox{predicted}+\mbox{error}
\]

or
\[y=\mu+\varepsilon\]

where

-   $\mu$ (mean) is the part of $Y$ that is explained by model 
-  $\varepsilon$ (residual) is the part of $Y$ that is not explained by model 


## A simple example
Regression model:

-  Model individual age from weight

\[
\text{age}_i=\alpha+\beta\cdot{\text{weight}}_i+\varepsilon_i
\]

where

-  $\alpha+\beta{x}_i$ is the mean of `age`, $y$, conditional on `weight`, $x$.
-  $\varepsilon_i$ is random variation 

## The linear model

The function `lm()` is a base function in `R` and allows you to define a variety of linear models. 

```{r}
args(lm)
```

If we want to know what these arguments do we can ask R:

```{r, eval=FALSE}
?lm
```

This will open a help page on the `lm()` function.

## Continuous predictors {.smaller}
To obtain a linear model with a main effect for `wgt`, we use the model formula $age\sim wgt$ 
```{r warning=FALSE, message = FALSE}
fit <- boys %$%
  lm(age ~ wgt)
fit
```

Notice that we use the `%$%` operator that exposes the elements (variables) of the `boys` data frame to be processed by the `lm()` function.

## More information with `summary()` {.smaller}
```{r}
fit %>% summary
```

## Continuous predictors
To obtain a linear model with just main effects for `wgt` and `hgt`, we use the model formula $age\sim wgt + hgt$ 

```{r}
fit <- boys %$%
  lm(age ~ wgt + hgt)
fit
```

## More information with `summary()` {.smaller}
```{r}
fit %>% summary
```

## Continuous predictors: interaction effects {.smaller}
To predict $age$ from $wgt$, $hgt$ and the interaction $wgt*hgt$ we use the following model formula for the interaction effect $age\sim wgt * hgt$
```{r}
fit <- boys %$% lm(age ~ wgt * hgt)
# wgt * hgt = wgt + hgt + wgt:hgt
fit
```

## More information with `summary()` {.smaller}
```{r}
fit %>% summary
```

## Categorical predictors in the linear model {.smaller}
If a categorical variable is entered into function `lm()`, it is automatically converted to a dummy set in `R`. The first level is always taken as the reference category. If we want another reference category we can use the function `relevel()` to change this.

```{r}
fit <- boys %$% lm(age ~ reg)
```

##  More information with `summary()` {.smaller}
```{r}
fit %>% summary
```

## Components of the linear model {.smaller}
```{r}
names(fit) # the names of the list with output objects
fit$coef  # show the estimated coefficients
coef(fit) # alternative
```

# Distributions


## Probability distributions

-  Normal distributions

    -  Linear model
    -  error distribution is normal

-  Discrete distributions (counts)

    -  Bernoulli, Binomial or Poisson model
    -  error distribution not normal

-  Other continuous distributions 

    -  Uniform, exponential 
    -  error distribution not normal

## Probability distributions in R {.smaller}

R has a system to work with probability distributions. For example the normal distribution:

`dnorm()`: **d** for density function

`pnorm()`: **p** for cumulative distribution $P(X \leqslant x)$

`qnorm()`: **q** for p-quantile

`rnorm()`: **r** for pseudo-random normally distributed numbers

Example: obtain critical *z*-value for 95% confidence interval:
```{r}
qnorm(0.975) # default: mean=0, sd=1
```

For other distributions, replace `norm` with: `f, chisq, binom, pois, exp, unif, gamma, beta, t`


# Discrete distributions

## Binomial distribution {.smaller}

Probability of $y$ successes in $n$ trials with probability of success $\pi$

\[
P(y|n,\pi)={n\choose y}\pi^y(1-\pi)^{(n-y)}
\]

For $n=5$ trials:
```{r echo=FALSE, fig.height=4}
par(mfrow=c(1,2), bg = NA)
y <- factor(0:5)
x <- 0:5
barplot(dbinom(x,5,.1), ylim=c(0,.6), names.arg=y, ylab="P(Y=y)", xlab="y")
text(5,.5,expression(paste(pi," = 0.1")))
barplot(dbinom(x,5,.5), ylim=c(0,.6), names.arg=y, ylab="P(Y=y)", xlab="y")
text(5,.5, expression(paste(pi," = 0.5")))
```

## Code that generates plot of previous slide {.smaller}
```{r eval=FALSE, fig.height=4}
par(mfrow=c(1,2), bg = NA)
y <- factor(0:5)
x <- 0:5
barplot(dbinom(x,5,.1), ylim=c(0,.6), names.arg=y, ylab="P(Y=y)", xlab="y")
        text(5,.5,expression(paste(pi," = 0.1")))
barplot(dbinom(x,5,.5), ylim=c(0,.6), names.arg=y, ylab="P(Y=y)", xlab="y")
        text(5,.5, expression(paste(pi," = 0.5")))
```

## Poisson distribution {.smaller}
The probability of $y$ events within a time period (e.g. number of earthquakes in a year)
\[
P(y|\lambda)=\frac{e^{-\lambda}\lambda^y}{y!}, \text{where } lambda=\text{rate parameter}
\]
```{r echo=FALSE, fig.height=4}
par(mfrow = c(1, 3), bg = NA)
y <- factor(0:5)
x <- 0:5
barplot(dpois(x, .5), ylim = c(0, .6), names.arg = y, 
        ylab = "P(Y=y)", xlab = "y")
text(5, .5, expression(paste(lambda, " = 0.5")))
barplot(dpois(x, 1), 
        ylim = c(0, .6), 
        names.arg = y, 
        ylab = "P(Y=y)", 
        xlab = "y")
text(5, .5, expression(paste(lambda, " = 1")))
barplot(dpois(x, 2), ylim = c(0, .6), names.arg = y, 
        ylab = "P(Y = y)",xlab="y")
text(5,.5,expression(paste(lambda," = 2")))
```


## Code that generates plot of previous slide{.smaller}
```{r eval=FALSE, fig.height=4}
par(mfrow = c(1, 3), bg = NA)
y <- factor(0:5)
x <- 0:5
barplot(dpois(x, .5), 
        ylim = c(0, .6), 
        names.arg = y, 
        ylab = "P(Y=y)", 
        xlab = "y")
text(5, .5, expression(paste(lambda, " = 0.5")))
barplot(dpois(x, 1), 
        ylim = c(0, .6), 
        names.arg = y, 
        ylab = "P(Y=y)", 
        xlab = "y")
text(5, .5, expression(paste(lambda, " = 1")))
barplot(dpois(x, 2), 
        ylim = c(0, .6), 
        names.arg = y, 
        ylab = "P(Y = y)",
        xlab="y")
text(5,.5,expression(paste(lambda," = 2")))
```

# Continuous distributions
## Normal distribution: pdf en cdf {.smaller}
The probability density function (pdf): 
```{r fig.height=4}
par(mfrow=c(1,2), bg=NA)
curve(dnorm(x,0,1),xlim=c(-3,3),ylab="f(x)",main='') 
curve(pnorm(x,0,1),xlim=c(-3,3),ylab="F(X < x)",main='')
```

## Exponential distribution

-  Waiting times (e.g. time until occurrence eartquake)
\[
f(t|\lambda)=\lambda{e}^{-\lambda{t}}
\]

```{r echo = FALSE, fig.height=4}
par(mfrow=c(1,2), bg = NA)
curve(dexp(x,2),from=0, to=5,xlab="t",ylab="f(t)",col="red",main='') 
curve(dexp(x,.5),from=0, to=5,main='',col="blue",add=TRUE) 
text(.8,1.8,expression(paste(lambda," = 2")),col="red")
text(4,0.25,expression(paste(lambda," = 0.5")),col="blue")
curve(pexp(x,2),from=0, to=5,xlab="t",ylab="F(T < t)",main='',col="red")
curve(pexp(x,.5),from=0, to=5,main='',col="blue",add=TRUE)
text(1.5,.8,expression(paste(lambda," = 2")),col="red")
text(2.3,0.5,expression(paste(lambda," = 0.5")),col="blue")
```

# Some more modeling 

## Performing a t-test {.smaller}
```{r}
cats %$% t.test(Hwt ~ Sex)
```

## Performing a chi-square test {.smaller}
Bacteria data: tests of the presence of the bacteria H. influenzae in children with otitis media in the Northern Territory of Australia. 
```{r}
bacteria %>% head(n=8)
```
Two categorical variables:

Column `y`:  `n` = disease absent, `y`= disease present.

Column `ap`: `a` = active medicine, `p`= placebo.

Nul hypothesis: there is no relation between disease status and treatment.

## Performing a chi-square test {.smaller}
```{r}
bacteria %$% table(ap, y)
```
```{r}
x2.table <- table(bacteria$ap, bacteria$y)
x2.table <- cbind(x2.table, rowSums(x2.table))
rbind(x2.table, colSums(x2.table))
```

## chi-square tests {.smaller}

$$\chi^2 = \sum \frac{(O - E)^2}{E}$$

- Observed: 
```{r echo = FALSE}
rbind(x2.table, colSums(x2.table))
```

- Expected:

```{r echo = FALSE}
bacteria %$% chisq.test(ap, y)$expected
```

## Performing a chi-square test {.smaller}
```{r}
prop.table(table(bacteria$ap, bacteria$y), margin = 1)
```

* In the treatment condition, 1/4 is free of disease. 

* In the placebo condition 1/8 is free of the disease. 

Should we assume this means the medicine works?

## Performing a chi-square test {.smaller}
```{r}
bacteria %$% chisq.test(ap, y)
```
or the other way around
```{r}
bacteria %$% chisq.test(y, ap)
```

## Or, equivalently: {.smaller}
```{r}
bacteria %$% table(ap, y) %>% chisq.test
```


## Visualizing this

```{r, dev.args = list(bg = 'transparent')}
bacteria %$% table(y, ap) %>% plot
```

## Visualizing this {.smaller}

```{r fig.height=4.5, dev.args = list(bg = 'transparent')}
barplot(table(bacteria$y, bacteria$ap), 
        beside = TRUE, 
        legend = c("No infection", "Infection"), 
        col = c("blue", "orange"),
        args.legend = list(x=4.5, y=80))
```



